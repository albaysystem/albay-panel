<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ALBAY STEPS • Panel</title>
<style>
body{background:#000;color:#fff;font-family:Arial;display:grid;place-items:center;height:100vh;margin:0}
.card{background:#111;border:1px solid #333;padding:20px;border-radius:15px;width:330px;text-align:center}
button{width:100%;padding:10px;background:#e11d2e;border:none;border-radius:8px;color:#fff;font-weight:700;margin-top:12px}
.kpi{display:flex;justify-content:space-between;margin-top:15px}
.kpi div{background:#222;padding:12px;border-radius:10px;width:30%}
</style>
</head>
<body>
<div class="card">
  <h2>ALBAY STEPS</h2>
  <div id="emailText"></div>
  <div class="kpi">
    <div>Günlük<br><b id="d">0</b></div>
    <div>Toplam<br><b id="t">0</b></div>
    <div>Puan<br><b id="p">0</b></div>
  </div>
  <button id="add">+100 Adım (Test)</button>
  <button id="exit">Çıkış Yap</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyAEQy9wEnip-cIsBRUdm6raL_uTkwxQVC8",
  authDomain:"albay-steps.firebaseapp.com",
  projectId:"albay-steps"
};
const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

function day(){ let d=new Date(),m=(d.getMonth()+1).toString().padStart(2,"0"),t=d.getDate().toString().padStart(2,"0"); return `${d.getFullYear()}-${m}-${t}` }

async function load(email){
 document.getElementById("emailText").textContent=email;
 const uref=doc(db,"users",email);
 const u=await getDoc(uref);
 const data=u.exists()?u.data():{};
 document.getElementById("t").textContent=data.totalSteps||0;
 document.getElementById("p").textContent=data.points||0;

 const sref=doc(db,"users",email,"dailyStats",day());
 const snap=await getDoc(sref);
 document.getElementById("d").textContent=snap.exists()?snap.data().steps:0;

 document.getElementById("add").onclick=()=>window.__addStepsFromApp(100);
 document.getElementById("exit").onclick=()=>signOut(auth).then(()=>location.href="index.html");
}

window.__addStepsFromApp=async function(add){
 const user=auth.currentUser;if(!user)return;
 const email=user.email;
 const uref=doc(db,"users",email);
 const sref=doc(db,"users",email,"dailyStats",day());
 const s=await getDoc(sref);
 const cur=s.exists()?s.data().steps:0;
 const newSteps=cur+add;
 const earn=Math.floor(newSteps/100);
 await setDoc(sref,{steps:newSteps,earned:earn,updatedAt:serverTimestamp()},{merge:true});
 const u=await getDoc(uref);const ud=u.data()||{};
 await updateDoc(uref,{totalSteps:(ud.totalSteps||0)+add,points:(ud.points||0)+Math.floor(add/100)});
 load(email);
};

onAuthStateChanged(auth,u=>u?load(u.email):location.href="index.html");
</script>
</body>
</html>
